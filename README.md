# NearBytes v1.0

A cryptographic protocol for storing and sharing immutable data collections with end-to-end encryption.

## Overview

NearBytes is a content-addressed storage system that provides:

- **Content-addressed storage**: Data identified by SHA-256 hash
- **End-to-end encryption**: AES-256-GCM for data, ECDSA P-256 for signatures
- **Immutable event logs**: Signed events that cannot be modified
- **Channel-based organization**: Each channel identified by a public key
- **Deterministic key derivation**: Channels recreated from secrets

## Professor Quick Start (MEGA Storage)

**Prerequisites:**
- Node.js 18+ and npm
- MEGA desktop app installed and running
- MEGA shared folder synced locally at `$HOME/MEGA/NearbytesStorage`

**‚ö†Ô∏è Important MEGA Setup:**
- **Accept the MEGA share** when you receive it (check MEGA desktop app or web interface)
- **Wait for sync to complete** - the MEGA desktop app will show sync status. Files must be fully synced before Nearbytes can access them.
- **Verify sync location:** The folder should be at `$HOME/MEGA/NearbytesStorage` (or set `NEARBYTES_STORAGE_DIR` to your actual sync path)

**üö® Critical: MEGA Sync Configuration**
- **ONLY sync `$HOME/MEGA/NearbytesStorage`** - NOT your entire home directory
- In MEGA Settings ‚Üí Syncs, ensure you have a sync for:
  - **Local folder:** `/Users/yourname/MEGA/NearbytesStorage`
  - **MEGA folder:** `/MEGA/NearbytesStorage` (or the shared folder path)
- **DO NOT** sync `/Users/yourname` or your entire home directory
- **Verify:** Run `ls ~/MEGA` - should only show `NearbytesStorage`, not Desktop/Documents/Downloads/etc.
- If you see your entire home directory syncing, remove that sync and create a new one for only `NearbytesStorage`

**Steps:**

1. **Clone and install:**
   ```bash
   git clone <github-url-provided-to-you>
   cd Nearbytes
   npm install
   cd ui && npm install && cd ..
   ```

2. **Verify MEGA folder is synced:**
   ```bash
   # Quick check - should show files if synced
   ls -la "$HOME/MEGA/NearbytesStorage" | head
   ```
   
   If the folder doesn't exist or is empty:
   - Check MEGA desktop app is running
   - Verify you accepted the MEGA share
   - Wait for sync to complete (check MEGA app status)
   - If your MEGA folder is in a different location, set `NEARBYTES_STORAGE_DIR` to that path

3. **Start server and UI:**
   ```bash
   npm run mega
   ```
   
   **Note:** On Windows (without WSL/Git Bash), use the manual approach instead:
   ```bash
   # Windows (PowerShell/CMD)
   $env:NEARBYTES_STORAGE_DIR="$env:USERPROFILE\MEGA\NearbytesStorage"
   npm run dev
   ```
   
   Or manually on macOS/Linux:
   ```bash
   export NEARBYTES_STORAGE_DIR="$HOME/MEGA/NearbytesStorage"
   npm run dev
   ```

   This starts both:
   - Backend server on `http://localhost:3000`
   - UI dev server on `http://localhost:5173`

4. **Open browser:**
   - Navigate to `http://localhost:5173`
   - Type `LeedsUnited` in the secret field
   - Files should appear if the MEGA folder is synced and contains data

**Troubleshooting:**

- **MEGA folder not at default location:** If your MEGA folder is synced elsewhere, set the environment variable:
  ```bash
  export NEARBYTES_STORAGE_DIR="/path/to/your/mega/sync/folder"
  npm run dev
  ```

- **Empty folder:** If `ls -la "$HOME/MEGA/NearbytesStorage"` shows an empty folder:
  - Ensure MEGA desktop app is running
  - Check that you accepted the MEGA share invitation
  - Wait for MEGA sync to complete (check MEGA app for sync status)
  - Verify files exist in MEGA web interface

- **Files not appearing:** See [docs/professor-verify.md](docs/professor-verify.md) for detailed troubleshooting.

For verification steps, see [docs/professor-verify.md](docs/professor-verify.md).

## Installation

```bash
npm install
npm run build
```

## Quick Start (CLI)

### 1. Setup a Channel

```bash
nearbytes setup --secret "mychannel:mypassword"
```

This creates a new channel and outputs the public key.

### 2. Store Data

```bash
nearbytes store --file ./photo.jpg --secret "mychannel:mypassword"
```

Outputs:
- Event hash: `abc123...`
- Data hash: `def456...`

### 3. List Events

```bash
nearbytes list --secret "mychannel:mypassword"
```

Lists all events in the channel.

### 4. Retrieve Data

```bash
nearbytes retrieve --event abc123... --secret "mychannel:mypassword" --output ./retrieved-photo.jpg
```

Retrieves and decrypts the data.

## Architecture Overview

NearBytes follows a layered architecture:

1. **Crypto Layer**: Cryptographic primitives (hash, symmetric, asymmetric)
2. **Storage Layer**: Abstract storage backend with filesystem implementation
3. **Domain Layer**: High-level protocol operations
4. **CLI Layer**: Command-line interface
5. **Server Layer**: HTTP API server (Phase 2)
6. **UI Layer**: Web interface (Phase 3)

See [docs/architecture.md](docs/architecture.md) for details.

## Phase 1: Encrypted File Layer

NearBytes includes a file-aware event layer that derives file state solely by replaying
the append-only event log for a secret-derived channel. There is no mutable index; the
current file list is reconstructed deterministically from events.

Example usage:

```ts
import { addFile, listFiles, getFile } from './src/domain/fileService.js';
import { readFileSync } from 'fs';

const secret = 'mychannel:mypassword';
await addFile(secret, 'photo.jpg', readFileSync('photo.jpg'), 'image/jpeg');
const files = await listFiles(secret);
const data = await getFile(secret, files[0].blobHash);
```

## Phase 2: Local File Server API

Nearbytes includes a stateless local API server that exposes the Phase 1 file
service over HTTP. Every request supplies either a secret header or a stateless
Bearer token derived from the secret.

### Run the server

```bash
npm install
npm run build
export NEARBYTES_STORAGE_DIR="./nearbytes-storage"  # Optional, defaults to ./nearbytes-storage
npm run server
```

The server runs on `http://localhost:3000` by default.

### Configuration

Environment variables:

- `PORT` (default: `3000`) - Server port
- `NEARBYTES_STORAGE_DIR` (default: `./nearbytes-storage`) - Storage directory. **Single source of truth** for where the server reads/writes `channels/` and `blocks/`. Set this to your MEGA sync folder when using MEGA (see below).
- `NEARBYTES_SERVER_TOKEN_KEY` (optional) - 32-byte key (hex or base64) to enable Bearer tokens
- `NEARBYTES_CORS_ORIGIN` (default: `http://localhost:5173`) - CORS origin
- `NEARBYTES_MAX_UPLOAD_MB` (default: `50`) - Maximum upload size in MB

**Setting storage for MEGA (macOS / Linux / WSL):**
```bash
export NEARBYTES_STORAGE_DIR="$HOME/MEGA/NearbytesStorage"
```
**Example MEGA paths:** macOS `~/MEGA/NearbytesStorage`, Windows `%USERPROFILE%\MEGA\NearbytesStorage`, Linux `$HOME/MEGA/NearbytesStorage`, MEGA Cloud Drive on macOS `~/Library/CloudStorage/MEGA/...`.

**Quick verification (after starting the server):**
```bash
# See what path the server is using (from startup logs or debug endpoint)
curl -s http://localhost:3000/__debug/storage | jq .

# List channel dirs and block count (replace STORAGE_DIR with value from above)
ls -la "$NEARBYTES_STORAGE_DIR/channels"
ls "$NEARBYTES_STORAGE_DIR/blocks" | wc -l
```

**Debug endpoints (storage only; no secrets):**
- `GET /__debug/storage` - Resolved storage path, channel/block counts, MEGA path hints
- `GET /__debug/channel/:id` - Channel dir path, existence, event file list (name, size, mtime) for channel id (public key hex)

### API Endpoints

- `POST /open` - Open a volume with a secret
- `GET /files` - List files in a volume
- `POST /upload` - Upload a file (multipart/form-data)
- `GET /file/:hash` - Download a file by blob hash
- `DELETE /files/:name` - Delete a file by name
- `GET /health` - Health check

### Try the API (secret header mode)

```bash
curl -X POST http://localhost:3000/open \
  -H "Content-Type: application/json" \
  -d '{"secret":"my volume"}'

curl http://localhost:3000/files \
  -H "x-nearbytes-secret: my volume"

curl -X POST http://localhost:3000/upload \
  -H "x-nearbytes-secret: my volume" \
  -F "file=@./photo.jpg"

curl -L http://localhost:3000/file/<hash> \
  -H "x-nearbytes-secret: my volume" \
  -o out.bin

curl -X DELETE http://localhost:3000/files/photo.jpg \
  -H "x-nearbytes-secret: my volume"
```

### Try the API (bearer token mode)

```bash
TOKEN=$(curl -s http://localhost:3000/open \
  -H "Content-Type: application/json" \
  -d '{"secret":"my volume"}' | jq -r '.token')

curl http://localhost:3000/files \
  -H "Authorization: Bearer ${TOKEN}"
```

More details: [docs/api-server.md](docs/api-server.md)

## Phase 3: Branded Svelte 5 UI

Nearbytes includes a modern web UI built with Svelte 5 that provides a beautiful, reactive interface for managing encrypted files.

### Run the UI

**Option 1: Run both server and UI together (recommended):**
```bash
export NEARBYTES_STORAGE_DIR="./nearbytes-storage"  # Or your MEGA folder
npm run dev
```

This starts both the backend server (port 3000) and UI dev server (port 5173).

**Option 2: Run separately:**

**Terminal 1 - Backend:**
```bash
npm run build
npm run server
```

**Terminal 2 - UI:**
```bash
cd ui
npm install  # First time only
npm run dev
```

Open `http://localhost:5173` in your browser.

### UI Features

- **Secret-based access**: Enter a secret to instantly materialize files
- **Drag & drop upload**: Drop files to add them to a volume
- **Download & delete**: Click files to download, delete button to remove
- **Offline support**: Cached file listings work offline
- **PWA**: Installable as a web app with service worker caching

The UI proxies API calls to the backend running on port 3000. See [ui/README.md](ui/README.md) for detailed setup instructions and [docs/ui.md](docs/ui.md) for architecture details.

More details: [docs/ui.md](docs/ui.md)

## Phase 4: MEGA-backed Storage (Desktop Sync Folder)

Nearbytes can use MEGA desktop sync folder as the storage backend. This enables automatic cloud sync of encrypted blobs and logs across multiple machines.

### Setup MEGA Storage

1. **Create MEGA sync folder:**
   ```bash
   mkdir -p "$HOME/MEGA/NearbytesStorage"
   ```

2. **Configure MEGA desktop app:**
   - Open MEGA desktop app
   - Add `$HOME/MEGA/NearbytesStorage` as a sync folder
   - Wait for initial sync to complete

3. **Run backend and UI together:**
   ```bash
   export NEARBYTES_STORAGE_DIR="$HOME/MEGA/NearbytesStorage"
   npm run dev
   ```

   This starts both the backend server (port 3000) and UI dev server (port 5173).
   The server will log: `Using storage dir: /Users/yourname/MEGA/NearbytesStorage`

   **Or run separately:**
   ```bash
   # Terminal 1 - Backend
   export NEARBYTES_STORAGE_DIR="$HOME/MEGA/NearbytesStorage"
   npm run build
   npm run server

   # Terminal 2 - UI
   cd ui
   npm run dev
   ```

### How It Works

- **Local encryption**: Nearbytes encrypts all files locally before writing to storage
- **MEGA stores ciphertext**: Only encrypted blobs and event logs are stored in MEGA
- **Secret controls access**: The secret is never stored in MEGA; it's only used locally to derive encryption keys
- **Cross-machine sync**: Share the MEGA folder across machines to enable shared storage

### Convenience Scripts

**Start server and UI together:**
```bash
export NEARBYTES_STORAGE_DIR="$HOME/MEGA/NearbytesStorage"
npm run dev
```

**Or use the provided script to start just the server with MEGA storage:**
```bash
./scripts/run-mega.sh
```

This script automatically sets `NEARBYTES_STORAGE_DIR` and ensures the directory exists.

### Important Warnings

‚ö†Ô∏è **Do not rename or move the MEGA folder** once you start storing volumes unless you also update the `NEARBYTES_STORAGE_DIR` environment variable accordingly.

‚ö†Ô∏è **Keep MEGA client running** for automatic sync. Files written by Nearbytes will sync to MEGA cloud automatically.

‚ö†Ô∏è **Never commit the MEGA folder** into git. Add it to `.gitignore` if it's in your repository.

### Verification

See [docs/verify-mega.md](docs/verify-mega.md) for step-by-step verification instructions.

More details: [docs/mega.md](docs/mega.md)

## Storage Structure

Logical storage layout (conceptual, not hard-coded paths):

```
/storage
  /blocks/<hash>.bin          # Encrypted file blobs (content-addressed)
  /channels/<channel-id>/     # Event logs per channel
    /<event-hash>.bin         # Signed event entries
```

Files are stored as:
- **Blocks**: Encrypted file content, named by SHA-256 hash
- **Channels**: Event logs organized by channel (volume) public key
- **Events**: Immutable signed events that reconstruct file state

See [docs/file-system.md](docs/file-system.md) for detailed storage structure.

## Security

- All data is encrypted with AES-256-GCM
- Signatures use ECDSA P-256
- Keys derived using PBKDF2 with 100,000 iterations
- No external crypto libraries (Web Crypto API only)
- Secrets are never stored - only used locally to derive keys

See [docs/crypto.md](docs/crypto.md) for cryptographic details.

## Development

### Setup

```bash
# Install dependencies
npm install
cd ui && npm install && cd ..

# Build
npm run build

# Test
npm test

# Lint
npm run lint

# Format
npm run format
```

### Development Workflow

**Start both server and UI:**
```bash
npm run dev
```

**Start only server:**
```bash
npm run dev:server
```

**Start only UI:**
```bash
npm run dev:ui
```

### Scripts

- `npm run build` - Build TypeScript to JavaScript
- `npm run server` - Run backend server
- `npm run dev` - Run both server and UI together
- `npm run dev:server` - Build and run server
- `npm run dev:ui` - Run UI dev server
- `npm test` - Run tests
- `npm run lint` - Lint code
- `npm run format` - Format code

## Documentation

- [Architecture](docs/architecture.md) - System architecture overview
- [Cryptographic Details](docs/crypto.md) - Encryption and signing details
- [API Reference](docs/api.md) - API endpoint documentation
- [API Server Guide](docs/api-server.md) - Server setup and configuration
- [Usage Guide](docs/usage.md) - CLI usage examples
- [File System Model](docs/file-system.md) - Storage structure details
- [UI Documentation](docs/ui.md) - UI architecture and features
- [MEGA Integration](docs/mega.md) - MEGA storage setup guide
- [Professor Verification](docs/professor-verify.md) - Step-by-step verification
- [MEGA Verification](docs/verify-mega.md) - MEGA storage verification

## License

MIT
